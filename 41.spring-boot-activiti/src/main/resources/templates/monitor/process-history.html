<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>流程历史</title>
    <!-- 引入vue -->
    <script src="/js/vue-2.7.15.js"></script>
    <!-- 引入element ui -->
    <link rel="stylesheet" href="/integration/element-ui/css/index.css">
    <script src="/integration/element-ui/js/element-ui.js"></script>
    <!-- 引入axios -->
    <script src="/js/axios.js"></script>
    <!-- 引入公共css样式 -->
    <link rel="stylesheet" href="/css/common.css">
</head>

<body>
    <div id="app">
        <div>
            <!-- 搜索区域 -->
            <el-card class="search" shadow="always">
                <!-- 搜索表单区域 -->
                <!-- inline 属性可以让表单域变为行内的表单域 -->
                <el-form inline :model="searchForm" class="search-form" size="small">
                    <el-row>
                        <el-col :span="4">
                            <el-form-item label="关键词">
                                <el-input v-model="searchForm.keywords" clearable placeholder="名称"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="6">
                            <el-form-item>
                                <el-button type="primary" icon="el-icon-search" @click="handlerSearch">查 询</el-button>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </el-card>

            <el-card class="content" shadow="always">
                <!-- 表格 -->
                <el-table stripe border v-loading="loading" :data="data" align="center" style="width: 100%;">
                    <!-- 表头 -->
                    <el-table-column label="序号" type="index" width="100" :resizable="false" align="center">
                    </el-table-column>
                    <template v-for="(column, index) in columns">
                        <el-table-column :key="index" :prop="column.prop" :label="column.label" :width="column.width"
                            align="center" :show-overflow-tooltip="column.showOverflowTooltip">
                        </el-table-column>
                    </template>
                    <!-- 按钮 -->
                    <el-table-column fixed="right" align="center" label="操作" width="220">
                        <template v-slot="scope">
                            <el-button icon="el-icon-s-promotion" @click="handlerShowHistory(scope.row.id)" type="text"
                                size="small" style="color: rgb(78,193,242)">
                                查看历史
                            </el-button>
                            <el-button icon="el-icon-s-promotion" @click="handlerShowVariable(scope.row.id)" type="text"
                                size="small" style="color: rgb(78,193,242)">
                                查看变量
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>

            <!-- 分页信息 -->
            <div class='pagination-container'>
                <el-pagination :background="false" :current-page.sync="paginationData.current"
                    :page-size.sync="paginationData.size" layout="total, sizes, prev, pager, next, jumper"
                    :page-sizes="[1, 5, 10, 20, 30, 50]" :total="paginationData.total" v-bind="$attrs"
                    @size-change="handleSizeChange" @current-change="handleCurrentChange">
                </el-pagination>
            </div>

            <!-- 查看历史 -->
            <el-dialog title="查看历史" :visible="historyVisible" width="70%" :before-close="handleHistoryClose">

                <el-card shadow="always" class="show-dialog">
                    <!-- 表格 -->
                    <el-table stripe border v-loading="historyLoading" :data="historyData" align="center"
                        style="width: 100%;">
                        <!-- 表头 -->
                        <el-table-column label="序号" type="index" width="100" :resizable="false" align="center">
                        </el-table-column>
                        <template v-for="(column, index) in historyColumns">
                            <el-table-column :key="index" :prop="column.prop" :label="column.label"
                                :width="column.width" align="center"
                                :show-overflow-tooltip="column.showOverflowTooltip">
                            </el-table-column>
                        </template>
                    </el-table>
                </el-card>

                <!-- 分页信息 -->
                <div class='pagination-container'>
                    <el-pagination :background="false" :current-page.sync="historyPaginationData.current"
                        :page-size.sync="historyPaginationData.size" layout="total, sizes, prev, pager, next, jumper"
                        :page-sizes="[1, 5, 10, 20, 30, 50]" :total="historyPaginationData.total" v-bind="$attrs"
                        @size-change="historyHandleSizeChange" @current-change="historyHandleCurrentChange">
                    </el-pagination>
                </div>

                <div slot="footer" class="dialog-footer">
                    <el-button @click="handleHistoryClose">取 消</el-button>
                    <el-button type="primary" @click="handleHistoryClose">确 定</el-button>
                </div>
            </el-dialog>

            <!-- 查看变量 -->
            <el-dialog title="查看变量" :visible="variableVisible" width="70%" :before-close="handleVariableClose">

                <el-card shadow="always" class="show-dialog">
                    <!-- 表格 -->
                    <el-table stripe border v-loading="variableLoading" :data="variableData" align="center"
                        style="width: 100%;">
                        <!-- 表头 -->
                        <el-table-column label="序号" type="index" width="100" :resizable="false" align="center">
                        </el-table-column>
                        <template v-for="(column, index) in variableColumns">
                            <el-table-column :key="index" :prop="column.prop" :label="column.label"
                                :width="column.width" align="center"
                                :show-overflow-tooltip="column.showOverflowTooltip">
                            </el-table-column>
                        </template>
                    </el-table>
                </el-card>

                <!-- 分页信息 -->
                <div class='pagination-container'>
                    <el-pagination :background="false" :current-page.sync="variablePaginationData.current"
                        :page-size.sync="variablePaginationData.size" layout="total, sizes, prev, pager, next, jumper"
                        :page-sizes="[1, 5, 10, 20, 30, 50]" :total="variablePaginationData.total" v-bind="$attrs"
                        @size-change="variableHandleSizeChange" @current-change="variableHandleCurrentChange">
                    </el-pagination>
                </div>

                <div slot="footer" class="dialog-footer">
                    <el-button @click="handleVariableClose">取 消</el-button>
                    <el-button type="primary" @click="handleVariableClose">确 定</el-button>
                </div>
            </el-dialog>
        </div>
    </div>
</body>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                // 列表表头
                columns: [
                    {
                        prop: 'processDefinitionName',
                        label: '流程名称',
                        width: 180,
                    },
                    {
                        prop: 'startUserName',
                        label: '流程发起人',
                        width: 180,
                    },
                    {
                        prop: 'businessKey',
                        label: '业务key',
                        width: 180,
                    },
                    {
                        prop: 'endedName',
                        label: '是否结束',
                        width: 180,
                    },
                    {
                        prop: 'taskName',
                        label: '任务名称',
                        width: 180,
                    },
                    {
                        prop: 'assigneeName',
                        label: '办理人',
                        width: 180,
                    },
                    {
                        prop: 'startTime',
                        label: '开始时间',
                    },
                    {
                        prop: 'endTime',
                        label: '结束时间',
                    },
                ],
                // 列表数据
                data: [],
                // 搜索条件
                searchForm: {
                    keywords: ""
                },
                // 分页参数
                paginationData: {
                    size: 10,
                    current: 1,
                    total: 0,
                },
                // 加载状态
                loading: false,
                // 流程实例id标记
                processInstanceId: undefined,
                // ========================================查看历史========================================
                // 查看历史表头
                historyColumns: [
                    {
                        prop: 'taskName',
                        label: '任务名称',
                        width: 180,
                    },
                    {
                        prop: 'assigneeName',
                        label: '办理人',
                        width: 180,
                    },
                    {
                        prop: 'startTime',
                        label: '开始时间',
                    },
                    {
                        prop: 'endTime',
                        label: '结束时间',
                    },
                ],
                // 查看历史列表数据
                historyData: [],
                // 查看历史分页参数
                historyPaginationData: {
                    size: 10,
                    current: 1,
                    total: 0,
                },
                // 查看历史弹窗状态
                historyVisible: false,
                // 查看历史加载状态
                historyLoading: false,

                // ========================================查看变量========================================
                // 查看变量表头
                variableColumns: [
                    {
                        prop: 'variableName',
                        label: '变量名称',
                        width: 180,
                    },
                    {
                        prop: 'variableTypeName',
                        label: '变量类型',
                        width: 180,
                    },
                    {
                        prop: 'value',
                        label: '变量值',
                        width: 180,
                    },
                    {
                        prop: 'createTime',
                        label: '创建时间',
                    },
                    {
                        prop: 'lastUpdatedTime',
                        label: '最后更新时间',
                    },
                ],
                // 查看历史列表数据
                variableData: [],
                // 查看历史分页参数
                variablePaginationData: {
                    size: 10,
                    current: 1,
                    total: 0,
                },
                // 查看变量弹窗状态
                variableVisible: false,
                // 查看历史加载状态
                variableLoading: false,
            }
        },
        mounted() {
            this.getData();
        },
        methods: {
            // 搜索
            handlerSearch() {
                this.getData();
            },
            // ==========================================查看历史==========================================
            async handlerShowHistory(id) {
                this.processInstanceId = id;
                this.historyVisible = true;
                this.historyLoading = true;
                let res = await axios.post('/process/history/' + this.processInstanceId, { ...this.historyPaginationData });
                if (res.data.code === 200 && res.data.data) {
                    this.historyData = res.data.data.rows;
                    this.historyPaginationData.total = res.data.data.total;
                } else {
                    this.$message.error(res.data.msg);
                }
                this.historyLoading = false;
            },
            // 关闭查看历史弹窗
            handleHistoryClose() {
                this.historyVisible = false;
            },
            // 页码切换
            historyPagination(data) {
                this.historyPaginationData = { ...this.historyPaginationData, current: data.current };
                this.handlerShowHistory(this.processInstanceId);
            },
            /**
             * pageSize 改变时会触发
             * @param val 每页条数
             */
            historyHandleSizeChange(val) {
                this.historyPagination({ current: this.historyPaginationData.currentPage, size: val });
            },
            /**
             * currentPage 改变时会触发
             * @param val 当前页
             */
            historyHandleCurrentChange(val) {
                this.historyPagination({ current: val, size: this.historyPaginationData.pageSize });
            },
            // ==========================================查看变量==========================================
            async handlerShowVariable(id) {
                this.processInstanceId = id;
                this.variableVisible = true;
                this.variableLoading = true;
                let res = await axios.post('/process/variable/' + this.processInstanceId, { ...this.variablePaginationData });
                if (res.data.code === 200 && res.data.data) {
                    this.variableData = res.data.data.rows;
                    this.variablePaginationData.total = res.data.data.total;
                } else {
                    this.$message.error(res.data.msg);
                }
                this.variableLoading = false;
            },
            // 关闭查看变量弹窗
            handleVariableClose() {
                this.variableVisible = false;
            },
            // 页码切换
            variablePagination(data) {
                this.variablePaginationData = { ...this.variablePaginationData, current: data.current };
                this.handlerShowVariable(this.processInstanceId);
            },
            /**
             * pageSize 改变时会触发
             * @param val 每页条数
             */
            variableHandleSizeChange(val) {
                this.variablePagination({ current: this.variablePaginationData.currentPage, size: val });
            },
            /**
             * currentPage 改变时会触发
             * @param val 当前页
             */
            variableHandleCurrentChange(val) {
                this.variablePagination({ current: val, size: this.variablePaginationData.pageSize });
            },
            // ==========================================基础列表==========================================
            // 获取列表
            async getData() {
                this.loading = true;
                let res = await axios.post('/process/all/paged', { ...this.searchForm, ...this.paginationData });
                if (res.data.code === 200 && res.data.data) {
                    this.data = res.data.data.rows;
                    this.paginationData.total = res.data.data.total;
                } else {
                    this.$message.error(res.data.msg);
                }
                this.loading = false;
            },
            // 页码切换
            pagination(data) {
                this.paginationData = { ...this.paginationData, current: data.current };
                this.getData();
            },
            /**
             * pageSize 改变时会触发
             * @param val 每页条数
             */
            handleSizeChange(val) {
                this.pagination({ current: this.paginationData.currentPage, size: val });
            },
            /**
             * currentPage 改变时会触发
             * @param val 当前页
             */
            handleCurrentChange(val) {
                this.pagination({ current: val, size: this.paginationData.pageSize });
            },
        }
    })
</script>
<style>
    .show-dialog {
        height: 500px;
        overflow: auto;
    }
</style>

</html>