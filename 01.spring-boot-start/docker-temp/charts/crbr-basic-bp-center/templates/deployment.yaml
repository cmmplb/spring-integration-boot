apiVersion: apps/v1
# 资源类型:Deployment
kind: Deployment
# 元数据
metadata:
  namespace: {{ .Values.namespace }}
  # 必须,服务名称
  name: {{ .Values.service.name  }}
  # 标签,indent 缩进字符
  labels:
{{ include "service.labels.standard" . | indent 4 }}
    project: {{ .Values.namespace }}
    app: {{ .Values.service.name }}
# Deployment规格说明
spec:
  # 实例数量
  replicas: {{ .Values.replicaCount }}
  revisionHistoryLimit: 10
  serviceName: {{ .Values.service.name }}
  selector:
    matchLabels:
{{ include "service.match.labels" . | indent 6 }}
      project: {{ .Values.namespace }}
      app: {{ .Values.service.name }}
# Pod 的模板
  template:
    metadata:
      annotations:
        project-type: supv3
      labels:
{{ include "service.labels.standard" . | indent 8 }}
        project: {{ .Values.namespace }}
        app: {{ .Values.service.name }}
        version: {{.Values.image.version}}
  # Pod 的规格
    spec:
      containers:
      # 容器名称
      - name: {{ .Values.service.name }}
        # 拉取镜像
        image: "{{ .Values.image.repository }}:{{ .Values.image.version }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        # imagePullSecrets: {{ .Values.image.imagePullSecrets}}
        env:
{{- range $name, $value := .Values.env.open }}
{{- if not (empty $value) }}
        - name: {{ $name | quote }}
          value: {{ $value | quote }}
{{- end }}
{{- end }}
        # 暴露端口, 可以通过IP:PORT访问
        ports:
        - containerPort: {{ .Values.service.port }}
          name: http
          protocol: TCP
          targetPort: {{ .Values.service.port }}
        livenessProbe:
          httpGet:
            path: {{ .Values.http.path }}
            port: {{ .Values.deployment.managementPort }}
          failureThreshold: 3
          initialDelaySeconds: 60
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 10
        # 读数探针,确定容器是否启动成功
        # initialDelaySeconds :容器启动后第一次执行探测是需要等待多少秒
        # periodSeconds       :执行探测的频率.默认是10秒,最小1秒
        # timeoutSeconds      :探测超时时间.默认1秒,最小1秒
        # successThreshold    :探测失败后,最少连续探测成功多少次才被认定为成功.默认是1.对于liveness必须是1.最小值是1.
        # failureThreshold    :探测成功后,最少连续探测失败多少次才被认定为失败.默认是3.最小值是1
        readinessProbe:
          exec:
            command: ["/bin/sh","-c","curl -s {{ .Values.http.url }}:{{ .Values.deployment.managementPort }}/{{ .Values.http.path }}"]
          failureThreshold: 3
          initialDelaySeconds: 60
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 10
        # 容器资源
        resources:
{{ toYaml .Values.resources | indent 10 }}
        volumeMounts:
          - mountPath: /nas
            name: sup-nas
      volumes:
        - name: sup-nas
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.pvcName }}
  updateStrategy:
    type: RollingUpdate
